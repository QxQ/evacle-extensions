<html>
<head>
<script>
unloaded = []
function match(tabID,unloaded) {
	for (i=0;i<unloaded.length;++i) {
		if (unloaded[i] == tabID) return i;
	}
	return null
}
chrome.tabs.onRemoved.addListener(function(tabID) {
	unloaded.splice(match(tabID,unloaded),1)
});
function unloadTab(tab,noScreenShot,changeTab) {
	unloaded[unloaded.length] = tab.id
	if (localStorage["screenShot"]!=1 && noScreenShot!=true) {
		chrome.tabs.captureVisibleTab(tab.windowId, {quality:10}, function(img) {
			chrome.tabs.executeScript(tab.id, {code:
				"window.location.reload();"+
				"window.stop();"+
				"document.write(\"<img id=\\\"screenshotOverDocument\\\" src=\\\""+img+"\\\"></img>\")"
			}, function(){})
		});
	} else {
		chrome.tabs.executeScript(tab.id, {code:
			"window.location.reload();"+
			"window.stop();"+
			"document.write(\"<h1 align=\\\"center\\\">this page is unloaded</h1>\")"
		}, function(){})
	}
	
	if (localStorage["changeTab"]!=false) {
		chrome.windows.getAll({"populate":true}, function(windows){
			nextTab=false
			past=[null,null]
			brk=false
			for (i=0;i<windows.length;++i) {
				for (j=0;j<windows[i].tabs.length;++j) {
					if (windows[i].tabs[j].id==tab.id) {
						nextTab=true
					} else if (nextTab) {
						chrome.tabs.update(windows[i].tabs[j].id, {"active":true}, function(){})
						brk=true
						break
					}
					past[1]=past[0]
					past[0]=windows[i].tabs[j].id
				}
				if (brk) {break}
			}
			if (brk!=true && past[1]!=null) {
				chrome.tabs.update(past[1], {"active":true}, function(){})
			}
		});
	}
}
chrome.browserAction.onClicked.addListener(function(tab) {
	if (match(tab.id,unloaded) != null) {
		chrome.tabs.reload(tab.id)
		unloaded.splice(match(tab.id,unloaded),1)
	} else {
		unloadTab(tab)
	}
	
});

chrome.tabs.onActiveChanged.addListener(function(tabID) {
	if (match(tabID,unloaded) != null) {
		chrome.tabs.reload(tabID)
		unloaded.splice(match(tabID,unloaded),1)
	}
});

chrome.tabs.onCreated.addListener(function(newTab) {
	if (localStorage["dontLoadNew"]==1) {
		chrome.tabs.getSelected(null, function(currentTab) {
			if (currentTab.id!=newTab.id) {
				chrome.tabs.get( newTab.id, function(tab){unloadTab(tab,true,false)} )
			}
		});
	}

});
</script>
</head>
</html>
<!-- vim: set sw=2 ts=2 et: -->
